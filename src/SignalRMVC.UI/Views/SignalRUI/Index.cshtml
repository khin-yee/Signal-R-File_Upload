@model SIgnalRTest.Domain.Request.MessageRequestDtos
@{
    ViewData["Title"] = "SignalR Real-Time Chat";
    string currentUser = "UserMVC"; 
}

<div class="card shadow-lg rounded-4 p-4 mx-auto my-4" style="max-width: 800px;">
    <h4 class="text-center text-muted text-dark fw-bold mb-2 pt-2">
        📡 Chat App
    </h4>
    <p class="text-center text-muted mb-4 fs-6">Send and receive live messages in real time</p>

    <div id="chatHistory" class="p-3 mb-4 bg-white rounded-5 border overflow-auto custom-scroll" style="max-height: 320px;">
        <p class="text-muted mb-3 small">
            🕒 Chat History
        </p>
        @if (Model is not null)
        {
            @foreach (var msg in Model.Messages)
            {
                if (msg.userid == currentUser)
                {
                    <div class="d-flex  justify-content-end mb-3">
                        <div class="chat-bubble you text-start">
                            <strong class="text-dark">You</strong><br />
                            <span>@msg.message</span><br />
                            <small class="text-muted">@msg.sendtime</small>
                        </div>
                        <div class="ms-2 avatar bg-primary  text-white">
                            @msg.userid.Substring(0, 1).ToUpper()
                        </div>
                    </div>
                }
                else
                {
                    <div class="d-flex justify-content-start mb-3">
                        <div class="me-2 avatar bg-secondary text-white">
                            @msg.userid.Substring(0, 1).ToUpper()
                        </div>
                        <div class="chat-bubble other">
                            <strong class="text-dark">@msg.userid</strong><br />
                            <span>@msg.message</span><br />
                            <small class="text-muted">@msg.sendtime</small>
                        </div>
                    </div>
                }
            }
        }
    </div>

    <form asp-action="CallApi" method="get" class="mt-3">
        <div class="input-group">
            <input type="text" name="message" class="form-control no-focus" placeholder="Type your message..." required />
            <button type="submit" class="btn btn-secondary">
                <i class="bi bi-send-fill"></i> Send
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script type="module">
        import { SignalRService } from '/js/signalrService.js';
        if (!window.signalRInitialized) 
        {
            window.signalRInitialized = true; 
            const signalR = new SignalRService("https://localhost:7055");
            await signalR.start();
            await signalR.joinGroup("123");

            signalR.onReceiveMessage("ReceiveMessage", async (message, userId, sendtime) => {
                console.log(`Message from ${userId}: ${message} at ${sendtime}`);
                const request = {
                    message: message,
                    userid: userId,
                    sendtime: sendtime
                };
                const query = new URLSearchParams(request).toString();
                window.location.href = `/SignalRUI/Index?${query}`;
            });
        }
    </script>
}

<style>
    .chat-bubble {
        padding: 12px 18px;
        border-radius: 20px;
        max-width: 70%;
        background-color: #f1f1f1;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

        .chat-bubble.you {
            background-color: #e3f2fd;
        }

        .chat-bubble.other {
            background-color: #f1f1f1;
        }

    .form-control.no-focus:focus {
        box-shadow: none !important; /* Removes Bootstrap's shadow */
        border-color: #ced4da !important; /* Default neutral border */
        outline: none !important; /* Removes the blue outline in some browsers */
    }

    .avatar {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .custom-scroll {
        scroll-behavior: smooth;
    }
</style>
